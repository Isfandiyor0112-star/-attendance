<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Admin-Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container mt-4">
    <h2 data-i18n="admin_panel_title">Админ-панель школы №22</h2>
    <div class="row mb-3">
      <div class="col-md-4">
        <label for="dateFilter" class="form-label" data-i18n="choose_date">Выберите дату:</label>
        <select id="dateFilter" class="form-select"></select>
      </div>
      
    </div>
    <div class="row mt-4">
      <div class="col-md-4">
        <div class="card text-bg-primary mb-3">
          <div class="card-body">
            <h5 class="card-title" data-i18n="total_absent">Всего отсутствующих</h5>
            <p class="card-text fs-2" id="totalAbsent">0</p>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card mb-3">
          <div class="card-body">
            <h5 class="card-title" data-i18n="reason_stats">Статистика причин отсутствия</h5>
            <canvas id="reasonChart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>
    <!-- Добавленная кнопка -->
    <div class="d-flex justify-content-end mb-3">
      <button id="clearHistory" class="btn btn-danger" data-i18n="clear_history">Очистить историю</button>
    </div>
    <h4 class="mt-4" data-i18n="absent_list">Список отсутствующих</h4>
    <ul id="adminAbsentList" class="list-group"></ul>
  </div>
  <div class="position-absolute top-0 end-0 p-3" style="z-index:10000;">
    <div class="btn-group">
      <button id="lang-ru" class="btn btn-light btn-sm">
        <img src="https://flagcdn.com/16x12/ru.png" alt="RU"> Рус
      </button>
      <button id="lang-uz" class="btn btn-light btn-sm">
        <img src="https://flagcdn.com/16x12/uz.png" alt="UZ"> Uzb
      </button>
    </div>
  </div>
  <button id="logoutBtn" style="position:fixed;right:20px;bottom:20px;z-index:9999;" class="btn btn-danger">Выйти</button>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="admin.js"></script>
  <script>
let absents = JSON.parse(localStorage.getItem('absents')) || [];

// Получаем уникальные даты
const allDates = [...new Set(absents.map(item => item.date))];

// Заполняем выпадающий список дат
const dateFilter = document.getElementById('dateFilter');
allDates.forEach(date => {
  const option = document.createElement('option');
  option.value = date;
  option.textContent = date;
  dateFilter.appendChild(option);
});

// По умолчанию показываем первую дату
let selectedDate = allDates[0] || '';
dateFilter.value = selectedDate;

// Обновление графиков и списков по выбранной дате
function renderByDate(date) {
  document.getElementById('totalAbsent').textContent =
    absents.filter(item => item.date === date).length;

  // Очищаем контейнер для графиков
  const oldCharts = document.querySelectorAll('.class-charts-row');
  oldCharts.forEach(el => el.remove());

  // Получаем классы за выбранную дату
  const classes = [...new Set(absents.filter(item => item.date === date).map(item => item.className))];

  // Контейнер для графиков и списков
  const chartsContainer = document.createElement('div');
  chartsContainer.className = "row class-charts-row";
  document.querySelector('.container').appendChild(chartsContainer);

  classes.forEach(className => {
    const classAbsents = absents.filter(item => item.date === date && item.className === className);

    // Группируем по причинам
    const stats = {};
    classAbsents.forEach(item => {
      stats[item.reason] = (stats[item.reason] || 0) + 1;
    });
    const labels = Object.keys(stats);
    const data = Object.values(stats);

    // Элементы для графика и списка
    const col = document.createElement('div');
    col.className = "col-md-4 mb-4";
    const card = document.createElement('div');
    card.className = "card";
    const cardBody = document.createElement('div');
    cardBody.className = "card-body";
    const title = document.createElement('h5');
    title.textContent = `Класс: ${className}`;
    const canvas = document.createElement('canvas');
    canvas.height = 120;

    // Список отсутствующих для этого класса
    const ul = document.createElement('ul');
    ul.className = "list-group mt-3";
    classAbsents.forEach(item => {
      const li = document.createElement('li');
      li.className = "list-group-item";
      li.textContent = `${item.studentName} (${item.reason})`;
      ul.appendChild(li);
    });

    cardBody.appendChild(title);
    cardBody.appendChild(canvas);
    cardBody.appendChild(ul);
    card.appendChild(cardBody);
    col.appendChild(card);
    chartsContainer.appendChild(col);

    // Рисуем pie chart
    new Chart(canvas.getContext('2d'), {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: 'Причины',
          data: data,
          backgroundColor: [
            '#0d6efd', '#e67e22', '#e74c3c', '#2ecc71', '#f1c40f', '#8e44ad'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const reason = context.label;
                const count = context.parsed;
                return [
                  `Причина: ${reason}`,
                  `Всего: ${count}`
                ];
              }
            }
          }
        }
      }
    });
  });

  renderReasonBarChart(date);
}

function renderReasonBarChart(date) {
  // Группируем по причинам для выбранной даты
  const stats = {};
  absents.filter(item => item.date === date).forEach(item => {
    stats[item.reason] = (stats[item.reason] || 0) + 1;
  });
  const labels = Object.keys(stats);
  const data = Object.values(stats);

  // Очищаем старый график, если есть
  if (window.reasonChart) window.reasonChart.destroy();

  // Рисуем bar chart
  const ctx = document.getElementById('reasonChart').getContext('2d');
  window.reasonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Причины отсутствия',
        data: data,
        backgroundColor: '#0d6efd'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `Всего: ${context.parsed.y}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  });
}

// Слушаем изменение даты
dateFilter.addEventListener('change', function() {
  selectedDate = this.value;
  renderByDate(selectedDate);
});

// Первый рендер
if (selectedDate) renderByDate(selectedDate);

// Кнопка очистки истории
document.getElementById('clearHistory').onclick = function() {
  if (confirm('Вы уверены, что хотите очистить всю историю отсутствующих?')) {
    localStorage.removeItem('absents');
    location.reload();
  }
};

const translations = {
  ru: {
    admin_panel_title: "Админ-панель школы №22",
    choose_date: "Выберите дату:",
    total_absent: "Всего отсутствующих",
    reason_stats: "Статистика причин отсутствия",
    clear_history: "Очистить историю",
    absent_list: "Список отсутствующих"
    // ...добавьте остальные тексты
  },
  uz: {
    admin_panel_title: "22-maktab admin paneli",
    choose_date: "Sana tanlang:",
    total_absent: "Yo‘qlarning jami",
    reason_stats: "Yo‘qlik sabablari statistikasi",
    clear_history: "Tarixni tozalash",
    absent_list: "Yo‘qliklar ro‘yxati"
    // ...добавьте остальные тексты
  }
};

function setLang(lang) {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (translations[lang][key]) el.textContent = translations[lang][key];
  });
  localStorage.setItem('lang', lang);
}

document.getElementById('lang-ru').onclick = () => setLang('ru');
document.getElementById('lang-uz').onclick = () => setLang('uz');

// При загрузке страницы
setLang(localStorage.getItem('lang') || 'ru');
  </script>
</body>
</html>
